<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>재고 관리</title>
  <style>
    :root{--bg:#0f1115;--text:#e7e9ee;--muted:#a7afc0;--accent:#ff6b6b}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",Arial,sans-serif}
    .wrap{height:100%;display:grid;place-items:center}
    .stage{width:100%;height:100vh;display:grid}
    @supports(height:100svh){.stage{height:100svh}}
    .loader{width:54px;height:54px;border-radius:50%;
      border:5px solid rgba(255,255,255,.15);border-top-color:var(--accent);
      animation:spin 1s linear infinite;margin:28px auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .msg{color:var(--muted);font-size:14px;text-align:center;margin:0 16px}
    iframe{width:100%;height:100%;border:0;display:none}
  </style>

  <!-- ★ 부모가 localStorage를 대행하고, 자식과 핸드셰이크로 자격 전달 -->
  <script>
    // 1) 자식의 get/set/remove 요청 처리
    window.addEventListener("message", (e) => {
      const d = e.data || {};
      if (d && d.__bridge === "req") {
        let value = null;
        try {
          if (d.op === "get")    value = localStorage.getItem(d.key);
          if (d.op === "set")    localStorage.setItem(d.key, d.value);
          if (d.op === "remove") localStorage.removeItem(d.key);
        } catch (_) {}
        e.source && e.source.postMessage({ __bridge: "ok", id: d.id, value }, "*");
      }
    });

    // 2) 부모 → 자식: 자격 푸시
    function pushCreds(targetWindow){
      try{
        const employeeId   = localStorage.getItem("employeeId");
        const employeeName = localStorage.getItem("employeeName");
        targetWindow && targetWindow.postMessage(
          { __bridge:"pushCreds", employeeId, employeeName },
          "*"
        );
      }catch(_){}
    }

    // 3) 핸드셰이크(재전송) — 자식이 받을 때까지 600ms 간격으로 최대 20회
    let hsTimer=null, hsTries=0;
    function startHandshake(targetWindow){
      stopHandshake();
      hsTries=0;
      hsTimer = setInterval(() => {
        hsTries++;
        pushCreds(targetWindow);
        if (hsTries >= 20) stopHandshake();
      }, 600);
    }
    function stopHandshake(){ if(hsTimer){ clearInterval(hsTimer); hsTimer=null; } }

    // 4) 자식이 needCreds/credsAck 보냄 → 처리
    window.addEventListener("message", (e) => {
      const d = e.data || {};
      if (d && d.__bridge === "needCreds") {
        pushCreds(e.source);
        startHandshake(e.source);          // 혹시 못 받으면 반복 전송
      }
      if (d && d.__bridge === "credsAck") {
        stopHandshake();                    // 수신 확인되면 중단
      }
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div id="loading">
      <div class="loader" aria-hidden="true"></div>
      <p class="msg">앱을 불러오는 중…</p>
    </div>
    <div class="stage" id="stage"></div>
  </div>

  <script>
    /* ★ Apps Script 웹앱 배포 URL로 바꾸세요 */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJH-JnPB-kGiytXaxM3qmKf32KylVkSz-Rfcioy9L7cVCA80gkzrrQdGai2ZQ4jsTzrQ/exec";

    (function mount(){
      const stage = document.getElementById("stage");
      stage.innerHTML = "";
      const iframe = document.createElement("iframe");
      iframe.id = "app";
      iframe.src = APPS_SCRIPT_URL;
      iframe.onload = () => {
        document.getElementById("loading").style.display = "none";
        iframe.style.display = "block";
        // onload 후에도 혹시 자식이 리스너 준비 전일 수 있으니 핸드셰이크 시작
        startHandshake(iframe.contentWindow);
      };
      stage.appendChild(iframe);
    })();
  </script>
</body>
</html>
